
{% extends "base.html" %}

{% block title %}メインページ{% endblock title %}

{% block extrahead %}
<style>
h3 {
  font-family: sans-serif;
  font-size: 30px;
  font-weight: bold;
}
.container {
  width: 1200px;
  }
table {
  margin-top: 8px;
}
/*.data_table {
  height:450px;
  width:350px;
  border-collapse: separate;
}*/
.data_table_scr {
  height:450px;
  width:350px;
  overflow-y:scroll;
  background-color: #D8F3F0;
}
.zu1 {
  height: 400px;
  width: 450px;
}
.memo {
  height:300px;
  width:400px;
}
.Calendar {
  width: 340px;
}
#area1 {
  /* boxレイアウトの指定 */
  display: box;
  display: -webkit-box;
  display: -moz-box;
  /* 配置したボックスを左右中央寄せにする */
  box-pack: center;
  -webkit-box-pack: center;
  -moz-box-pack: center;
  border: 1px solid #ccc;
  border-radius: 5px;
}
th {
  width: 25%;
  padding: 6px;
  text-align: center;
  vertical-align: top;
  color: black;
  background-color: darkgray;
  border: 1px solid black;
}
td {
  width: 25%;
  padding: 6px;
  background-color: #fff;
  border: 1px solid #b9b9b9;
}
.ave_table, .rec_ave_table, .max_table, .min_table {
  width: 27%;
  border-collapse: separate;
  clear: both;
}
.ave_table th {
  background-color: yellow;
  border: 2px solid orange;
}
.rec_ave_table th {
  background-color: lime;
  border: 2px solid green;
}
.max_table th {
  background-color: pink;
  border: 2px solid red;
}
.min_table th {
  background-color: aliceblue;
  border: 2px solid blue;
}
#table_area {
  /* boxレイアウトの指定 */
  display: box;
  display: -webkit-box;
  display: -moz-box;
  /* 配置したボックスを左右中央寄せにする */
  box-pack: center;
  -webkit-box-pack: center;
  -moz-box-pack: center;
  border: 1px solid #ccc;
  border-radius: 5px;
}
#chat-frame {
  min-width: 320px;
  max-width: 800px;
  margin: auto;
  padding: 1em 2em;
  background-color: #D8F3F0;
}
.chat-talk {
  overflow: hidden;
  margin: 0 0 1em 0;
  padding: 0;
}
.chat-talk span {
  display: block;
  margin: 0;
  padding: 0;
}
.chat-talk .talk-icon {
  float: left;
  width: auto;
}
.chat-talk .talk-content {
  position: relative;
  box-sizing: border-box;
  width: auto;
  min-height: 50px;
  border-radius: 10px;
  background-color: #fff;
  margin: 10px auto 0 10px;
  padding: 1em;
}
.chat-talk .talk-icon img {
  max-width: 100%;
  height: auto;
  vertical-align: bottom;
  border: 2px solid #fff;
  border-radius: 50%;
}
.chat-talk .talk-content:before {
  position: absolute;
  top: 15px;
  left: -20px;
  display: block;
  width: 0;
  height: 0;
  content: '';
  border: 10px solid transparent;
  border-right-color: #FFFFFF;
}
.chat-talk.mytalk .talk-icon {
  float: right;
}
.chat-talk.mytalk .talk-content {
  margin: 10px 10px 0 auto;
  color: #000;
  background: #78FF6C;
}
.chat-talk.mytalk .talk-content:before {
  right: -20px;
  left: auto;
  border-color: transparent;
  border-left-color: #78FF6C;
}
#memo_write_button {
    font-size: 1.4em;
    padding: 2px 150px;
    }
</style>
{% endblock %}

{% block content %}
<h3 class="page-header">メインページ</h3>

<div id="area1">
  <div id="area3">
  <div class="data_table_scr">
    <div id="chat-frame">
      <p class="chat-talk mytalk">
        <span class="talk-content">
          {% for i in dataset %}
            {{ i.datetime }}<br>
            気温：{{ i.temperature }}</br>
            水分量：{{ i.moisture }}</br>
            照度：{{ i.illuminance }}</br>
          {% endfor %}
        </span>
        <span class="talk-content" id="text">
          わたぬき、水やる？
        </span>
        <span class="talk-content" id="content"></span>
      </p>
      <p class="chat-talk">
        <span class="talk-content" id="content1"></span>
      </p>
    </div>
  </div>
  <form name="js">
  <input type="text" name="txtb" value="">
  <input type="button" value="送信" onclick="tbox1()">
  </form>
  <button id="btn">マイク</button>
  </div>
  <svg class="zu1" id="svg1" width="400" height="450">
    <image id="zu1" x="0" y="0" width="100%" height="100%" opacity="1"></image>
  </svg>
  <div id="area2">
    <div id="memo_area" width="600" height="560">
      <p><font size="6px" color="blue">Memo</font></p>
    <form name="memo_form" action="Sample.html">
      <textarea id="memo" name="memo" rows="10" cols="56" wrap="soft" onfocus="if(this.value==this.defaultValue){this.value=''}" onblur="if(this.value==''){this.value=this.defaultValue}"></textarea><br>
      <a id="memo_write_button" onclick="memo_write()" class="btn btn-default btn-sm">write</a>
    </form>
    </div>
    
    <div class="Calendar">
      <div id="cal0" class="cal_wrapper">
        Calendar Loading
      </div>
    </div>

  </div>
</div>

{% load staticfiles %}
<script type="text/javascript" charset="UTF-8" src="{% static 'js/cal.js' %}"></script>

<script type="text/javascript">
  d3.select("#zu1").attr("xlink:href","/site_media/"+"zu1.jpg");
  //memoをデータベースに転送
  function memo_write() {
    var memo_text = document.memo_form.memo.value;
    memo_text = memo_text.replace(/\r\n/g, '\n');
    var memo_lines = memo_text.split('\n');
    $.ajax({
      type: 'GET',
      url: make_url() + "&memo=" + memo_lines,
      dataType: 'json',
    });
  }
  //データベースのメモを表示
  function memo_get() {
    var memo_text = "";
    var cnt = 0;
    {% for i in memo_data %}
    if (cnt == 0) {
      memo_text = memo_text + "{{i}}";
    }
    else {
       memo_text = memo_text + "\n" + "{{i}}";
    }
    cnt++
    {% endfor %}
    document.memo_form.memo.value = memo_text;
  }

  //url作成用関数
function make_url() {
  var year = "{{datetime.year}}";
  var month = ("0"+"{{datetime.month}}").slice(-2);
  var day = ("0"+"{{datetime.day}}").slice(-2);
  var url = "{% url 'AIoT:detail_json' %}" + "?datetime=" + year + month + day;
  return url;
}

memo_get();
  // var ave_tmp = 0;
  // var ave_moi = 0;
  // var cnt = 0;
  // var recently_cnt = 0;
  // var rec_ave_tmp = 0;
  // var rec_ave_moi = 0;
  // var max_tmp = 0;
  // var max_moi = 0;
  // var min_tmp = 9999;
  // var min_moi = 9999;
  // recently_cnt = {{data_len}} - 10;
  // {% for i in dataset %}
  // ave_tmp = ave_tmp + {{ i.temperature }};
  // ave_moi = ave_moi + {{ i.moisture }};
  // if ({{i.temperature}} > max_tmp){
  //   max_tmp = {{i.temperature}}
  // }
  // if ({{i.moisture}} > max_moi){
  //   max_moi = {{i.moisture}}
  // }
  // if ({{i.temperature}} < min_tmp){
  //   min_tmp = {{i.temperature}}
  // }
  // if ({{i.temperature}} < min_moi){
  //   min_moi = {{i.moisture}}
  // }
  // if (cnt >= recently_cnt){
  //   rec_ave_tmp = rec_ave_tmp + {{ i.temperature }};
  //   rec_ave_moi = rec_ave_moi + {{ i.moisture }};
  // }
  // cnt = cnt + 1;
  // {% endfor %}
  // ave_tmp = ave_tmp/cnt;
  // ave_moi = ave_moi/cnt;
  // rec_ave_tmp = rec_ave_tmp/10;
  // rec_ave_moi = rec_ave_moi/10;
</script>
<!-- <div id="table_area">
    <table class="ave_table">
      <thead>
        <th>平均気温(全体)</th>
        <th>平均水分量(全体)</th>
      </thead>
      <tbody>
        <tr>
          <td align="center"><script>document.write(ave_tmp);</script></td>
          <td align="center"><script>document.write(ave_moi);</script></td>
        </tr>
      </tbody>
    </table>
    <table class="rec_ave_table">
      <thead>
        <th>平均気温(直近10件)</th>
        <th>平均水分量(直近10件)</th>
      </thead>
      <tbody>
        <tr>
          <td align="center"><script>document.write(rec_ave_tmp);</script></td>
          <td align="center"><script>document.write(rec_ave_moi);</script></td>
        </tr>
      </tbody>
    </table>
    <table class="max_table">
      <thead>
        <th>最大気温</th>
        <th>最大水分量</th>
      </thead>
      <tbody>
        <tr>
          <td align="center"><script>document.write(max_tmp);</script></td>
          <td align="center"><script>document.write(max_moi);</script></td>
        </tr>
      </tbody>
    </table>
    <table class="min_table">
      <thead>
        <th>最小気温</th>
        <th>最小水分量</th>
      </thead>
      <tbody>
        <tr>
          <td align="center"><script>document.write(min_tmp);</script></td>
          <td align="center"><script>document.write(min_moi);</script></td>
        </tr>
      </tbody>
    </table>
</div> -->

<script type="text/javascript">
//ここから雑談対話
var apiUrl = 'https://api.apigw.smt.docomo.ne.jp/dialogue/v1/dialogue?APIKEY=';
var apiKey = '4243356f65594f4435517944436f43345a42515767785831573876323459627a5938487839776c4d725338';
var api = apiUrl + apiKey;

var text = document.getElementById('text').textContent;

var apiJson = {

    'utt' : 'asdfg' // ←ここに雑話キーワードを入れる。テキスト入力ができるといいかも

}

// API送受信関数
function callBot(){
    $.ajax({
        type : 'post',
        url : api,
        data : JSON.stringify(apiJson),
        contentType: 'application/JSON',
        dataType : 'JSON',
        scriptCharset: 'utf-8'
    })
    .done(function(data){
        console.log(data.yomi); // ←いろんな雑話が返ってくる
        content.textContent = data.yomi;

        //ここから音声合成
        jQuery(function($) {
          xhr = new XMLHttpRequest();
          xhr.open('POST', 'https://api.apigw.smt.docomo.ne.jp/voiceText/v1/textToSpeech?APIKEY=4243356f65594f4435517944436f43345a42515767785831573876323459627a5938487839776c4d725338', true);
          xhr.responseType = 'arraybuffer'
          xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
          var datax = "text="+text+data.yomi+"&speaker=hikari&emotion=happiness&emotion_level=2&format=ogg";
          xhr.onload = function (e) {
            if( this.status == 200){
              view = new Uint8Array(this.response);
              blob = new Blob([view], { "type" : "audio/wav" });
              URL = window.URL || window.webkitURL;

              audio = new Audio(URL.createObjectURL(blob));
              audio.play();
            }
          };
          data1 = datax;
          xhr.send(data1);
        });
      })
    .fail(function(data){
    console.log(data.responseText); // ←エラー時の処理
  })
  }

// あとは色んなタイミングで実行
callBot();
// 例：やっほー => やっほっほー
// ※毎回同じとは限らない。結構いろんな回答が返ってきます
 
setInterval(callBot, 50000);

</script>

<script type="text/javascript">

//ここから雑談対話
var apiUrl = 'https://api.apigw.smt.docomo.ne.jp/dialogue/v1/dialogue?APIKEY=';
var apiKey = '4243356f65594f4435517944436f43345a42515767785831573876323459627a5938487839776c4d725338';
var api = apiUrl + apiKey;

//テキストボックスの文字を取得する
function tbox1(){
  var str1 = document.js.txtb.value;
  content1.textContent = str1;

var apiJson = {

    'utt' : String(str1) // ←ここに雑話キーワードを入れる。テキスト入力ができるといいかも

}

// API送受信関数
function callBot(){
    $.ajax({
        type : 'post',
        url : api,
        data : JSON.stringify(apiJson),
        contentType: 'application/JSON',
        dataType : 'JSON',
        scriptCharset: 'utf-8'
    })
    .done(function(data){
        console.log(data.yomi); // ←いろんな雑話が返ってくる
        content.textContent = data.yomi;

        //ここから音声合成
        jQuery(function($) {
    xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://api.apigw.smt.docomo.ne.jp/voiceText/v1/textToSpeech?APIKEY=4243356f65594f4435517944436f43345a42515767785831573876323459627a5938487839776c4d725338', true);

    xhr.responseType = 'arraybuffer'
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
    var datax = "text="+data.yomi+"&speaker=hikari&emotion=happiness&emotion_level=2&format=ogg";
    
    xhr.onload = function (e) {
        if( this.status == 200){
            view = new Uint8Array(this.response);
            blob = new Blob([view], { "type" : "audio/wav" });
            URL = window.URL || window.webkitURL;

            audio = new Audio(URL.createObjectURL(blob));
            audio.play();
        }
    };
    data1 = datax;
    xhr.send(data1);
});

    })
    .fail(function(data){
        console.log(data.responseText); // ←エラー時の処理
    })
}

// あとは色んなタイミングで実行
callBot();
// 例：やっほー => やっほっほー
// ※毎回同じとは限らない。結構いろんな回答が返ってきます
}

//ここから音声認識
var btn = document.getElementById('btn');
var content1 = document.getElementById('content1');
var speech = new webkitSpeechRecognition(); //音声認識APIの使用
speech.lang = "ja"; //言語を日本語に設定
btn.addEventListener( 'click' , function() {
    // ➀ボタンをクリックした時の処理
    speech.start(); // 音声認識をスタート
} );
speech.addEventListener( 'result' , function( e ) {
    // ➁音声認識した結果を得る処理
    var text1 = e.results[0][0].transcript; // 認識された「言葉」を、変数「text」に格納
    content1.textContent = text1; // 認識された「言葉(text)」を、表示用のdivタグに代入する
} );

</script>

{% endblock content %}
