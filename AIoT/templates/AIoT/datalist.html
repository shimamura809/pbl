
{% extends "base.html" %}

{% block title %}メインページ{% endblock title %}

{% block extrahead %}
<style>
h3 {
  font-family: sans-serif;
  font-size: 30px;
  font-weight: bold;
}
.container {
  width: 1200px;
  }
table {
  margin-top: 8px;
}
body {
  background-color: mintcream;
}
.data_table_scr {
  height:450px;
  width:350px;
  overflow-y:scroll;
  background-color: #D8F3F0;
  border: 4px solid #ccc;
}
#threshold_select{
  margin-top: 10px;
  border: 4px solid #ccc;
  background-color: white;
}
.zu1 {
  height: 590px;
  width: 430px;
  border: 4px solid mistyrose;
  margin-left: 1px;
  margin-right: 1px;
  background-color: white;
}
.memo {
  height:300px;
  width:400px;
}
.Calendar {
  width: 340px;
  margin: auto;
}
#TABLE_1 tbody{
  /*border: 4px solid #ccc;*/
}
#area0 {
  /* boxレイアウトの指定 */
  display: box;
  display: -webkit-box;
  display: -moz-box;
  /* 配置したボックスを左右中央寄せにする */
  box-pack: center;
  -webkit-box-pack: center;
  -moz-box-pack: center;
  /*border: 1px solid #ccc;*/
  border-radius: 5px;
  margin-top: 50px;
  /*margin: auto;*/
}

#area2 {
  border: 4px solid #ccc;
  background-color: white;
  height: 590px;
}

th {
  width: 25%;
  padding: 6px;
  text-align: center;
  vertical-align: top;
  color: black;
  background-color: darkgray;
  border: 1px solid black;
}
td {
  width: 25%;
  padding: 6px;
  background-color: #fff;
  border: 1px solid #b9b9b9;
}

#table_area {
  /* boxレイアウトの指定 */
  display: box;
  display: -webkit-box;
  display: -moz-box;
  /* 配置したボックスを左右中央寄せにする */
  box-pack: center;
  -webkit-box-pack: center;
  -moz-box-pack: center;
  border: 1px solid #ccc;
  border-radius: 5px;
}
#chat-frame {
  min-width: 320px;
  max-width: 800px;
  margin: auto;
  padding: 1em 2em;
  background-color: #D8F3F0;
}
.chat-talk {
  overflow: hidden;
  margin: 0 0 1em 0;
  padding: 0;
}
.chat-talk span {
  display: block;
  margin: 0;
  padding: 0;
}
.chat-talk .talk-icon {
  float: left;
  width: auto;
}
.chat-talk .talk-content {
  position: relative;
  box-sizing: border-box;
  width: auto;
  min-height: 50px;
  border-radius: 10px;
  background-color: #fff;
  margin: 0 auto 0 70px;
  padding: 1em;
}
.chat-talk .talk-icon img {
  max-width: 100%;
  height: auto;
  vertical-align: bottom;
  border: 2px solid #fff;
  border-radius: 50%;
}
.chat-talk .talk-content:before {
  position: absolute;
  top: 15px;
  left: -20px;
  display: block;
  width: 0;
  height: 0;
  content: '';
  border: 10px solid transparent;
  border-right-color: #FFFFFF;
}
.chat-talk.mytalk .talk-icon {
  float: right;
}
.chat-talk.mytalk .talk-content {
  margin: 10px 10px 0 auto;
  color: #000;
  background: #78FF6C;
}
.chat-talk.mytalk .talk-content:before {
  right: -20px;
  left: auto;
  border-color: transparent;
  border-left-color: #78FF6C;
}
#memo_write_button {
    font-size: 1.4em;
    }
</style>
{% endblock %}

{% block content %}

<div id="area0">
<div id="area1">
  <div class="data_table_scr">
    <div id="chat-frame">
      <p class="chat-talk mytalk">
        <span class="talk-content">
          {% for i in dataset %}
            {{ i.datetime }}<br>
            気温：{{ i.temperature }}</br>
            水分量：{{ i.moisture }}</br>
            照度：{{ i.illuminance }}</br>
          {% endfor %}
        </span>
        <span class="talk-content">
          わたぬき、水やる？
        </span>
      </p>
    </div>
  </div>
  <div id="threshold_select">
    <p><font size="5px" color="blue">水分量閾値</font></p>
    <form name="threshold_form" action="Sample.html">
      <textarea id="threshold" name="threshold"></textarea><br>
      <a id="threshold_write_button" onclick="threshold_write()" class="btn btn-info btn-block">更新</a>
    </form>
  </div>
</div>
  <svg class="zu1" id="svg1" width="400" height="450">
    <image id="zu1" x="0" y="0" width="100%" height="100%" opacity="1"></image>
  </svg>
  <div id="area2">
    <div id="memo_area">
      <p><font size="6px" color="blue">Memo</font></p>
    <form name="memo_form" action="Sample.html">
      <textarea id="memo" name="memo" rows="10" cols="56" wrap="soft" onfocus="if(this.value==this.defaultValue){this.value=''}" onblur="if(this.value==''){this.value=this.defaultValue}"></textarea><br>
      <a id="memo_write_button" onclick="memo_write()" class="btn btn-info btn-block">送信</a>
    </form>
    </div>
    <div class="Calendar">
      <!-- 0番目のカレンダーを入れる箱ね -->
      <div id="cal0" class="cal_wrapper">
        Calendar Loading
      </div>
    </div>
  </div>
</div>
{% load staticfiles %}
<script type="text/javascript" charset="UTF-8" src="{% static 'js/cal.js' %}"></script>

<script type="text/javascript">
  d3.select("#zu1").attr("xlink:href","/site_media/"+"zu1.jpg");
  //memoをデータベースに転送
  function memo_write() {
    var memo_text = document.memo_form.memo.value;
    memo_text = memo_text.replace(/\r\n/g, '\n');
    var memo_lines = memo_text.split('\n');
    $.ajax({
      type: 'GET',
      url: make_url("memo") + "&memo=" + memo_lines,
      dataType: 'json',
    });
  }
  //閾値をデータベースに転送
  function threshold_write() {
    var threshold_text = document.threshold_form.threshold.value;
    console.log(threshold_text);
    console.log(isNaN(threshold_text));
    if(isNaN(threshold_text)){
      console.log("miss");
      window.alert("半角数字で入力してください");
    } else{
      $.ajax({
        type: 'GET',
        url: make_url("threshold") + "?threshold=" + threshold_text,
        dataType: 'json',
      });
    }
  }
  //データベースのメモ・閾値を表示
  function db_get() {
    var memo_text = "";
    var cnt = 0;
    {% for i in memo_data %}
    if (cnt == 0) {
      memo_text = memo_text + "{{i}}";
    }
    else {
       memo_text = memo_text + "\n" + "{{i}}";
    }
    cnt++
    {% endfor %}
    document.memo_form.memo.value = memo_text;
    document.threshold_form.threshold.value = "{{threshold}}";
  }

  //url作成用関数
function make_url(str) {
  var year = "{{datetime.year}}";
  var month = ("0"+"{{datetime.month}}").slice(-2);
  var day = ("0"+"{{datetime.day}}").slice(-2);
  if (str == "memo"){
    var url = "{% url 'AIoT:memo_json' %}" + "?datetime=" + year + month + day;
  } else if (str == "threshold") {
    var url = "{% url 'AIoT:threshold_json' %}";
  }
  return url;
}

memo_get();
</script>

{% endblock content %}
