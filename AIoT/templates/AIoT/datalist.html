
{% extends "base.html" %}

{% block title %}メインページ{% endblock title %}

{% block extrahead %}
<style>
h3 {
  font-family: sans-serif;
  font-size: 30px;
  font-weight: bold;
}
.container {
  width: 1200px;
  }
table {
  margin-top: 8px;
}
body {
  background-color: mintcream;
}
.data_table_scr {
  height:519px;
  width:350px;
  overflow-y:scroll;
  background-color: #D8F3F0;
  /*border: 4px solid #ccc;*/
}
#threshold_select{
  /*margin-top: 10px;*/
  /*border: 4px solid #ccc;*/
  background-color: white;
}
.zu1 {
  height: 500px;
  width: 320px;
  border: 4px solid hotpink;
  /*margin-left: 1px;
  margin-right: 1px;*/
  background-color: white;
}
.memo {
  height:300px;
  width:400px;
}
.Calendar {
  width: 367px;
  /*margin: auto;*/
}
#area1 {
  /* boxレイアウトの指定 */
  display: box;
  display: -webkit-box;
  display: -moz-box;
  /* 配置したボックスを左右中央寄せにする */
  box-pack: center;
  -webkit-box-pack: center;
  -moz-box-pack: center;
  /*border: 1px solid #ccc;*/
  border-radius: 5px;
  margin-top: 20px;
}
#left {
  border: 4px solid dimgray;
  background-color: white;
  height: 550px;
}
#center {
  border-top: 4px solid dimgray;
  border-bottom: 4px solid dimgray;
  background-color: white;
  height: 550px;
}
#right {
  border: 4px solid dimgray;
  background-color: white;
  height: 550px;
}
th {
  width: 25%;
  padding: 6px;
  text-align: center;
  vertical-align: top;
  color: black;
  background-color: darkgray;
  border: 1px solid black;
}
td {
  width: 25%;
  padding: 6px;
  background-color: #fff;
  border: 1px solid #b9b9b9;
}
#table_area {
  /* boxレイアウトの指定 */
  display: box;
  display: -webkit-box;
  display: -moz-box;
  /* 配置したボックスを左右中央寄せにする */
  box-pack: center;
  -webkit-box-pack: center;
  -moz-box-pack: center;
  border: 1px solid #ccc;
  border-radius: 5px;
}
#chat-frame {
  min-width: 320px;
  max-width: 800px;
  margin: auto;
  padding: 1em 2em;
  background-color: #D8F3F0;
}
.chat-talk {
  overflow: hidden;
  margin: 0 0 1em 0;
  padding: 0;
}
.chat-talk span {
  display: block;
  margin: 0;
  padding: 0;
}
.chat-talk .talk-icon {
  float: left;
  width: auto;
}
.chat-talk .talk-content {
  position: relative;
  box-sizing: border-box;
  width: auto;
  min-height: 50px;
  border-radius: 10px;
  background-color: #fff;
  margin: 10px auto 0 10px;
  padding: 1em;
}
.chat-talk .talk-icon img {
  max-width: 100%;
  height: auto;
  vertical-align: bottom;
  border: 2px solid #fff;
  border-radius: 50%;
}
.chat-talk .talk-content:before {
  position: absolute;
  top: 15px;
  left: -20px;
  display: block;
  width: 0;
  height: 0;
  content: '';
  border: 10px solid transparent;
  border-right-color: #FFFFFF;
}
.chat-talk.mytalk .talk-icon {
  float: right;
}
.chat-talk.mytalk .talk-content {
  margin: 10px 10px 0 auto;
  color: #000;
  background: #78FF6C;
}
.chat-talk.mytalk .talk-content:before {
  right: -20px;
  left: auto;
  border-color: transparent;
  border-left-color: #78FF6C;
}
#memo_write_button {
    font-size: 1.4em;
}
#link_list {
  /*border: 4px solid #ccc;*/
}
.tbox {
  width: 266px;
}
#input {
  width: 80px;
  background-color: #248;
  border: none;
  color: #fff;
}
#input:hover{
  background-color: #24d;
  color: #fff;
}
#threshold{
  width: 50px
}
</style>
<script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.2/moment.min.js"></script>
{% endblock %}

{% block content %}

<div id="area1">
  <div id="left">
  <div class="data_table_scr" id="list">
    <div id="chat-frame">
      <!--<p class="chat-talk mytalk">
        <span class="talk-content">
          {% for i in dataset %}
            {{ i.datetime.year }}年{{ i.datetime.month }}月{{ i.datetime.day }}日{{ i.datetime.hour }}時{{ i.datetime.minute }}分<br>
            気温：{{ i.temperature }}</br>
            水分量：{{ i.moisture }}</br>
            照度：{{ i.illuminance }}</br>
          {% endfor %}
        </span>
        <span class="talk-content">-->
        <!--<span class="talk-content" id="text">-->
          <!--本日の水やり時刻は<br>
          {% for i in watertime %}
          {{i}}<br>
          {% endfor %}
          です。
        </span>
      </p>-->
    </div>
  </div>
  <form name="js">
  <input class="tbox" type="text" name="txtb" value="" onkeypress="enter(event.keyCode);">
  <input type="text" style="display: none;"/>
  <input id="input" type="button" value="送信" onclick="tbox1()">
  </form>
  <!-- <button id="btn">マイク</button> -->
  </div>
  <div id="center">
  <svg class="zu1" id="svg1" width="400" height="450">
    <image id="zu1" x="0" y="0" width="100%" height="100%" opacity="1"></image>
    <div id="watertime_select" align="center" style="background-color: lightblue; border: 4px solid greenyellow;">
    <form name="water_form" action="Sample.html">
    <font size="4px" style="font-weight: bold;">水やり時間</font>
      <script type="text/javascript">
      //セレクトボックスの作成
      document.write('<select name="water_time">');
      for (var i = 1; i < 11; i++) {
        document.write('<option value="'+i+'"/>'+i+"秒"+'</option>');};
      document.write('</select>');
      </script>
      <a id="water_control_button" onclick="water_control()" class="btn btn-info">水遣りスタート</a>
    </form>
    </div>
  </svg></div>
  <div id="right">
    <!-- <div id="memo_area" width="600" height="560">
      <p><font size="6px" color="blue">Memo</font></p>
    <form name="memo_form" action="Sample.html">
      <textarea id="memo" name="memo" rows="10" cols="56" wrap="soft" onfocus="if(this.value==this.defaultValue){this.value=''}" onblur="if(this.value==''){this.value=this.defaultValue}"></textarea><br>
      <a id="memo_write_button" onclick="memo_write()" class="btn btn-info btn-block">送信</a>
    </form>
    </div> -->
    <div class="Calendar" align="center">
      <div style="background-color: khaki; border-top: 4px solid royalblue; border-bottom: 4px solid royalblue;">
        <font size="5px" color="blue" style="font-weight: bold;">アーカイブ</font>
      </div>
      <div id="cal0" class="cal_wrapper">
        Calendar Loading
      </div>
    </div>
    <div id="threshold_select" align="center" style="background-color: lightblue; border: 4px solid greenyellow;">
    <form name="threshold_form" action="Sample.html">
    <font size="4px" style="font-weight: bold;">水分量閾値</font>
      <input id="threshold" name="threshold" maxlength="4" cols="4" rows="1"></input>
      <a id="threshold_write_button" onclick="threshold_write()" class="btn btn-info">更新</a>
    </form>
    </div>
    <div id="link_list" align="center">
      <div style="background-color: khaki; border-top: 4px solid royalblue; border-bottom: 4px solid royalblue;">
      <font size="5px" color="blue" style="font-weight: bold;">リンク</font>
      </div>
      <br>
      <a id="pict_list"></a>
      <a id="getdata"></a>
      <a id="mailaddress"></a>
    </div>
  </div>
</div>

{% load staticfiles %}
<script type="text/javascript" charset="UTF-8" src="{% static 'js/cal.js' %}"></script>

<script type="text/javascript">
  d3.select("#pict_list").attr({
    "class": "btn btn-info btn-sm btn-block",
    "href": "{% url 'AIoT:pict_list' %}",
    "style": "font-size: 1.2em;font-weight: bold;"
  }).text("画像一覧");
  d3.select("#getdata").attr({
    "class": "btn btn-info btn-sm btn-block",
    "href": "{% url 'AIoT:getdata' %}",
    "style": "font-size: 1.2em;font-weight: bold;"
  }).text("取得データ一覧");
  d3.select("#mailaddress").attr({
    "class": "btn btn-info btn-sm btn-block",
    "href": "{% url 'AIoT:mailaddress' %}",
    "style": "font-size: 1.2em;font-weight: bold;"
  }).text("メールアドレス変更");

  //画像切り替え用の関数(引数paraは文字列)
  function pict_change(para) {
    d3.select("#zu1").attr("xlink:href","/site_media/character/"+para+".jpg");
  }

  //memoをデータベースに転送
  function memo_write() {
    var memo_text = document.memo_form.memo.value;
    memo_text = memo_text.replace(/\r\n/g, '\n');
    var memo_lines = memo_text.split('\n');
    $.ajax({
      type: 'GET',
      url: make_url("memo") + "&memo=" + memo_lines,
      dataType: 'json',
    });
  }
  //閾値をデータベースに転送
  function threshold_write() {
    var threshold_text = document.threshold_form.threshold.value;
    if(threshold_text.match(/[^0-9]/g)||(parseInt(threshold_text, 10) + "" != threshold_text)){
      console.log("miss");
      window.alert("半角数字で入力してください");
    } else{
      $.ajax({
        type: 'GET',
        url: make_url("threshold") + "?threshold=" + threshold_text,
        dataType: 'json',
      });
    }
  }
  //水やりの命令を管理する関数
  function water_control() {
    var time = water_form.water_time.value * 1000;
    console.log(time);
    flag_water = !flag_water;
    if (flag_water) {
      $.ajax({
        type: 'GET',
        url: make_url("water") + "?water=ON",
        dataType: 'json',
      });
      d3.select("#water_control_button").text("水遣りストップ");
      water = setTimeout(water_control, time);
    } else{
      $.ajax({
        type: 'GET',
        url: make_url("water") + "?water=OFF",
        dataType: 'json',
      });
      d3.select("#water_control_button").text("水遣りスタート");
      clearTimeout(water);
    }
  }
  //データベース閾値を表示
  function db_get() {
    document.threshold_form.threshold.value = "{{threshold}}";
  }

  //音声によるページ推移用関数
  function move_page(str) {
    if (str == "画像") {
      location.href = "{% url 'AIoT:pict_list' %}";
    } else if (str == "取得データ") {
      location.href = "{% url 'AIoT:getdata' %}";
    } else if (str == "昨日") {
      var dt = new Date({{datetime.year}},{{datetime.month}}-1,{{datetime.day}});
      var prev_dt = moment(dt).subtract(1,"days").format("YYYYMMDD");
      location.href = "{% url 'AIoT:detail' %}" + "?datetime=" + prev_dt;
    } else if (str == "先週") {
      var dt = new Date({{datetime.year}},{{datetime.month}}-1,{{datetime.day}});
      var prev_we = moment(dt).subtract(1,"week").format("YYYYMMDD");
      location.href = "{% url 'AIoT:detail' %}" + "?datetime=" + prev_we;
    } else if (str == "今日") {
      location.href = "{% url 'AIoT:detail' %}";
    }
  }

  //url作成用関数
function make_url(str) {
  var year = "{{datetime.year}}";
  var month = ("0"+"{{datetime.month}}").slice(-2);
  var day = ("0"+"{{datetime.day}}").slice(-2);
  if (str == "threshold") {
    var url = "{% url 'AIoT:threshold_json' %}";
  } else if (str == "water") {
    var url = "{% url 'AIoT:water_json' %}";
  } else if (str == "get") {
    var url = "{% url 'AIoT:get_json' %}";
  }
  return url;
}


///////////////////////////////////////////////////////実行部//////////////////////////////////////////////
db_get();
pict_change("zu_normal");
var water;
var flag_water = false;


//ここから音声対話
var apiUrl = 'https://api.apigw.smt.docomo.ne.jp/dialogue/v1/dialogue?APIKEY=';
var apiKey = '4243356f65594f4435517944436f43345a42515767785831573876323459627a5938487839776c4d725338';
var api = apiUrl + apiKey;

//var text = document.getElementById('text').textContent;
var num = 0;

//雑談対話への適当なリクエストを用意
var apiJson1 = {
    'utt' : 'asdfg' // ←ここに雑話キーワードを入れる
}

//システム発話を表示・音声再生する
function OnseiGousei(onsei,get) {
  var target = document.getElementById("chat-frame");
  var newTag = document.createElement("span");
  newTag.innerHTML = '<p class="chat-talk mytalk"><span class="talk-content" id="content'+num+'"></span></p>';
  target.appendChild(newTag);
  if (get == true) {
    var target_id = document.getElementById("content"+num);
    var tag = "";
    for (var i = 0; i < 4; i++){
      tag = tag +onsei[i]+"<br>";
    }
    target_id.innerHTML = tag;
  } else {
    eval("content"+num+".textContent = onsei");
  }
  num = num + 1;
  $(function(){
    $(".data_table_scr").scrollTop($("#list")[0].scrollHeight);
  });
  xhr = new XMLHttpRequest();
  xhr.open('POST', 'https://api.apigw.smt.docomo.ne.jp/voiceText/v1/textToSpeech?APIKEY=4243356f65594f4435517944436f43345a42515767785831573876323459627a5938487839776c4d725338', true);
  xhr.responseType = 'arraybuffer'
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded")
  var datax = "text="+onsei+"&speaker=hikari&emotion=happiness&emotion_level=2&format=ogg";
  xhr.onload = function (e) {
    if( this.status == 200){
      view = new Uint8Array(this.response);
      blob = new Blob([view], { "type" : "audio/wav" });
      URL = window.URL || window.webkitURL;
      audio = new Audio(URL.createObjectURL(blob));
      audio.play();
    }
  };
  data1 = datax;
  xhr.send(data1);
};

//雑談対話Bot
function callBot(apiJson){
    $.ajax({
        type : 'post',
        url : api,
        data : JSON.stringify(apiJson),
        contentType: 'application/JSON',
        dataType : 'JSON',
        scriptCharset: 'utf-8'
    })
    .done(function(data){
        console.log(data.yomi); // ←いろんな雑話が返ってくる
        tmp_text = data.context;
        OnseiGousei(data.yomi);
      })
    .fail(function(data){
    console.log(data.responseText); // ←エラー時の処理
  })
}

//Repl-AIシステム初期発話
var request = new XMLHttpRequest();
request.open('POST', 'https://api.repl-ai.jp/v1/dialogue', true);
request.setRequestHeader("Content-Type", "application/json");
request.setRequestHeader("x-api-key", "utzD4E0CtN3Vw6lauIXS04JpvyGxoBrk9xUoOHiQ");
request.onload = function (e) {
  if(request.status == 200){
    //console.log(request.responseText);
    var res = JSON.parse(request.responseText);
    var res1 = res["systemText"];
    console.log(res1["expression"]);
    OnseiGousei(res1["utterance"]);
  }
};
var body = {
  appUserId:'o8gkTuc0E9gnjSYPVifLgeQ7ajD6eVqA',
  botId:'plantalk',
  voiceText:'init',
  initTalkingFlag:true,
  initTopicId:'talk1'
};
request.send(JSON.stringify(body));

//Repl-AIシステム発話
function callAPI(hatsuwa,RequestZatsudan){
  var request = new XMLHttpRequest();
  request.open('POST', 'https://api.repl-ai.jp/v1/dialogue', true);
  request.setRequestHeader("Content-Type", "application/json");
  request.setRequestHeader("x-api-key", "utzD4E0CtN3Vw6lauIXS04JpvyGxoBrk9xUoOHiQ");
  request.onload = function (e) {
    if( request.status == 200){
      //console.log(request.responseText);
      var res = JSON.parse(request.responseText);
      var res1 = res["systemText"];
      if(res1["expression"] == "NOMATCH"){//返答がNOMATCHならcallBotにリクエスト
        callBot(RequestZatsudan);
      }else{
        console.log(res1["expression"]);
        if(res1["expression"].match(/NOTTALK/)){
          NotTalkOperation(res1["expression"]);
        }else{
          OnseiGousei(res1["utterance"]);
        }
      }
    }
  };
  var body1 = {
    appUserId:'o8gkTuc0E9gnjSYPVifLgeQ7ajD6eVqA',
    botId:'plantalk',
    voiceText:hatsuwa,
    initTalkingFlag:false,
    initTopicId:'talk1'
  };
  request.send(JSON.stringify(body1));
}
function NotTalkOperation(NotTalkCode){
  if(NotTalkCode.match(/WATERING/)){
      water_control();
    } else if(NotTalkCode.match(/CONDITION/)){
      // OnseiGousei("少々お待ちください。");
      console.log("condition")
      DataGet("test");
    }
}
/*
//定期的な雑談対話システム発話
repetition = setTimeout("callBot(apiJson1)", 70000);
function interval1(){
  repetition = setTimeout("callBot(apiJson1)", 70000);
}
function interval2(){
    clearTimeout(repetition);
}
var input = document.getElementById("input");
input.addEventListener("click", interval2, false);
input.addEventListener("click", interval1, false);
*/

//ユーザ発話の表示(getTextContentsでmatchしたとき用)
function OnseiHyouji_User(value){
  var str1 = value;
  var target = document.getElementById("chat-frame");
  var newTag = document.createElement("span");
  newTag.innerHTML = '<p class="chat-talk"><span class="talk-content" id="content'+num+'"></span></p>';
  target.appendChild(newTag);
  eval("content"+num+".textContent = str1");
  num = num + 1;
}

//データ・画像取得用関数
function DataGet(value) {
  $.ajax({
      type: 'GET',
      url: make_url("get") + "?name=" + value,
      dataType: 'json',
      success: function(json){
        if(json["get"] == "success"){
          var json_list = [];
          json_list[0] = json["datetime"];
          json_list[1] = "気温 ： "+json["temperature"];
          json_list[2] = "水分量 ： "+json["moisture"];
          json_list[3] = "照度 ： "+json["illuminance"];
          OnseiGousei(json_list,true);
          GazouHyouji(json["file"]);
        } else{
          OnseiGousei("取得に失敗しました。。");
        }
        // OnseiGousei("(例)水やりはどうですか？");
      }
  });
  // GazouHyouji();
}

//画像表示用の関数
function GazouHyouji(file){
  // var date = value;
  var target = document.getElementById("chat-frame");
  var newTag = document.createElement("span");
  newTag.innerHTML = '<p class="chat-talk mytalk"><span class="talk-content" id="content'+num+'"><svg id="pict'+num+'"></svg></span></p>';
  target.appendChild(newTag);
  // eval("content"+num+".textContent = str1");
  d3.select("#pict"+num).append("image").attr({
      "xlink:href": "/site_media/now/" + file,
      "opacity":"1",
      'width' : "240px",
      'height' : "150px",
      "float" : "left",
      "margin" : "auto",
      "display": "block",
    });
  num = num + 1;
}

//テキストボックスの文字を取得する
function tbox1(){
  var str1 = document.js.txtb.value;
  console.log(str1);
  getTextContents(String(str1));
}

//入力フォームでエンター押下時も送信
function enter(code){
  //エンターキー押下なら
  if(13 === code){
    tbox1();
  }
}

//ユーザ発話の表示(getTextContentsでmatchしなかったとき用)
//callAPIにユーザ発話を渡す
function OnseiHyouji_User_API(value){
  var str1 = value;
  var str2 = tmp_text;

  if(value.match(/NOTTALK/)){
    console.log("nottalk")
  }else{
    var target = document.getElementById("chat-frame");
    var newTag = document.createElement("span");
    newTag.innerHTML = '<p class="chat-talk"><span class="talk-content" id="content'+num+'"></span></p>';
    target.appendChild(newTag);
    eval("content"+num+".textContent = str1");
    num = num + 1; 
  }

  //雑談対話へのリクエストの用意
  var apiJson3 = {
    'utt' : String(str1), // ←ここに雑話キーワードを入れる
    'context' : String(str2),
    "mode": "dialog"
  }

  //callBot(apiJson3);
  callAPI(str1,apiJson3);
}

//履歴を保存する変数
var tmp_text = "";
var i = 0;
function Speech_Rec(){
  //ここから音声認識
  //var btn = document.getElementById('btn');
  //var content1 = document.getElementById('content');
  var speech = new webkitSpeechRecognition(); //音声認識APIの使用

  var j = 0;
  var speech_status = 0;
  speech.start();
  speech.continuous = true;
  speech.interimResults = true;
  speech.lang = "ja"; //言語を日本語に設定
  /*btn.addEventListener( 'click' , function() {
      // ➀ボタンをクリックした時の処理
      speech.start(); // 音声認識をスタート
  } );*/
  speech.onerror = function(){
    if(speech_status == 0)
      Speech_Rec();
  }
  speech.onsoundend = function(){
    Speech_Rec();
  }
  speech.onresult = function(e){
      // ➁音声認識した結果を得る処理
      var results = e.results;
      var text1;
      for (var j = e.resultIndex; j <results.length; j++){
        if(results[j].isFinal){
          text1 = results[j][0].transcript;
        }
        else{
          text1 = "[認識中…]" + results[j][0].transcript;
          speech_status = 1;
        }
      }
      //var text1 = e.results[0][0].transcript; // 認識された「言葉」を、変数「text」に格納
      console.log(text1)
      switch(text1) {
        case "聞いて":
          i = 1;
          console.log(i)
          OnseiGousei("何でも聞きますよ");
          break;
        case "さよなら":
          i = 0;
          OnseiGousei("またお話しましょう");
          break;
        default:
          if(i == 1) {
            getTextContents(text1);
          }
          Speech_Rec();
    }
  }
}

//ユーザ発話のマッチング
function getTextContents(text1) {
    if(text1.match(/画像/)){
      OnseiHyouji_User(text1);
      OnseiGousei("了解しました");
      setTimeout(move_page, 2500, "画像")
    }　else if(text1.match(/取得データ/)){
      OnseiHyouji_User(text1);
      OnseiGousei("了解しました");
      setTimeout(move_page, 2500, "取得データ")
    }　else if(text1.match(/情報/)||text1.match(/詳細/)){
      if(text1.match(/昨日/)){
        OnseiHyouji_User(text1);
        OnseiGousei("了解しました");
        setTimeout(move_page, 2500, "昨日")
      } else if(text1.match(/先週/)){
        OnseiHyouji_User(text1);
        OnseiGousei("了解しました");
        setTimeout(move_page, 2500, "先週")
      } else {
        OnseiHyouji_User(text1);
        OnseiGousei("了解しました");
        setTimeout(move_page, 2500, "今日")
      }
    }　else {
      OnseiHyouji_User_API(text1);
    }
}

//ページ開始時に水分量を判定(テスト用)
var MoisJudge = Math.floor( Math.random() * 10 ) ;

if(MoisJudge == 0){
  OnseiHyouji_User_API("NOTTALKMOISTNO");
} else{
  OnseiHyouji_User_API("NOTTALKMOISTOK");
}

Speech_Rec();
</script>

{% endblock content %}
